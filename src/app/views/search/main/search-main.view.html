<div class="header-container">
  <div class="title-container">
    <mat-icon class="material-symbols-outlined title-icon">{{ MAPPING_TYPE[type].icon }}</mat-icon>
    <div class="title-content">
      <h1 class="title-label">{{ MAPPING_TYPE[type].title }}</h1>
      <div class="subtitle-label">{{ MAPPING_TYPE[type].subtitle }}</div>
    </div>
  </div>
  <div class="filter-container md-3" [formGroup]="serverFilterForm">
    <advanced-filter-recap [filters]="advancedParams" (filterRemoved)="handleRemovedFilter($event)"
                           (focusField)="focusField($event)"></advanced-filter-recap>
    <mat-form-field style="width: 315px" class="no-subscript" appearance="outline">
      <mat-label>Période</mat-label>
      <mat-date-range-input [formGroup]="serverFilterForm.controls.dateRangePicker" [rangePicker]="picker">
        <input matStartDate formControlName="start" placeholder="Start date" (dateChange)="onChangeStart($event)">
        <input matEndDate formControlName="end" placeholder="End date" (dateChange)="onChangeEnd($event)">
      </mat-date-range-input>
      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-date-range-picker #picker></mat-date-range-picker>
    </mat-form-field>
    <mat-form-field class="no-subscript" [class.loading]="serverNameIsLoading" appearance="outline">
      <mat-label>Serveur</mat-label>
      <mat-select [formControl]="serverFilterForm.controls.appname" multiple (selectionChange)="onChangeServer($event)">

        <span *ngIf="serverNameIsLoading && queryParams.appname[0]!=''"><mat-option
                *ngFor="let s of queryParams.appname" [value]="s">{{ s }}</mat-option></span>
        <mat-option *ngFor="let d of nameDataList" [value]="d">{{ d }}</mat-option>
      </mat-select>
      <mat-spinner *ngIf="serverNameIsLoading" [diameter]="18"></mat-spinner>
    </mat-form-field>
    <mat-form-field style="width: 200px" class="no-subscript" appearance="outline">
      <mat-label>Status</mat-label>
      <mat-select [formControl]="serverFilterForm.controls.rangestatus" multiple
                  (selectionChange)="onChangeStatus($event)">
        <mat-select-trigger style="display: flex; gap: 0.5em;">
          <div style="display: flex; flex: 1; gap: 0.5em;"
               *ngFor="let s of serverFilterForm.controls.rangestatus.value">
            <mat-icon [style.color]="s.color">
              {{ s.icon }}
            </mat-icon>
            {{ s.label }}
          </div>
        </mat-select-trigger>
        <mat-option *ngFor="let s of  filters" [value]="s">
          <div style="display: flex; align-content: center">
            <mat-icon [style.color]="s.color">
              {{ s.icon }}
            </mat-icon>
            {{ s.label }}
          </div>
        </mat-option>
      </mat-select>
    </mat-form-field>
    <button mat-mini-fab color="primary" (click)="search()">
      <mat-icon matSuffix>search</mat-icon>
    </button>
    <advanced-filter-trigger [pageName]="'session-main'"
                             [filterConfig]="filterConstants.SEARCH[type]"
                             [focusField]="focusFieldName"
                             [additionalFilter]="{'start.ge':queryParams.period.start?.toISOString(),'start.lt': queryParams.period.end?.toISOString()}"
                             (handleDialogclose)="handledialogclose($event)"
                             (handlePresetSelection)="handlePresetSelection($event)"
                             (handlePresetSelectionReset)="handlePresetSelectionReset()"
                             (handleFilterReset)="handleFilterReset()"></advanced-filter-trigger>
  </div>
</div>

<mat-form-field appearance="outline" class="searchwidth md-3 no-subscript">
  <input [disabled]="isLoading" matInput #input (keyup)="applyFilter($event)" placeholder="Filtrer..."
         autocomplete="off">
  <mat-icon matSuffix>search</mat-icon>
</mat-form-field>

<div class="table-container">
  <div class="table-wrapper">
    <table mat-table [dataSource]="dataSource" matSort matSortActive="start"
           matSortDirection="desc">

      <ng-container matColumnDef="app_name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header style="width:15%">
          <div class="header-cell-content">
            <mat-icon class="material-symbols-outlined">dns</mat-icon>
            Serveur
          </div>
        </th>
        <td mat-cell *matCellDef="let element"
            [ngClass]="{'success': element.end && (!element.exception?.type || !element.exception?.type),
                            'fail': element.end && (element.exception?.type || element.exception?.type),
                            'in-progress': !element.end}"
            [matTooltip]="(element.exception?.type | exceptionType) + ' ' + (element.exception?.message | truncString: 100)">
          {{ element["appName"] || 'N/A' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header style="width:15%">
          <div class="header-cell-content">
            Nom
          </div>
        </th>
        <td mat-cell *matCellDef="let row">
          {{ row.name || 'N/A' }}
        </td>
      </ng-container>


      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <div class="header-cell-content">
            Chemin
          </div>
        </th>
        <td mat-cell *matCellDef="let row" class="ellipsis">
          <span [matTooltip]="row.location">{{ row.location || 'N/A' }}</span>
        </td>
      </ng-container>


      <ng-container matColumnDef="start">
        <th mat-header-cell *matHeaderCellDef mat-sort-header style="width:15%">
          <div class="header-cell-content">
            <mat-icon class="material-symbols-outlined">schedule</mat-icon>
            Début
          </div>
        </th>
        <td mat-cell *matCellDef="let element">
          {{ (element.start*1000 |date:'dd/MM/yyyy')}}
          <br>
          {{ (element.start*1000 |date:'HH:mm:ss.SSS')}}
        </td>
      </ng-container>

      <ng-container matColumnDef="durée">
        <th mat-header-cell *matHeaderCellDef mat-sort-header style="width:15%">
          <div class="header-cell-content">
            <mat-icon class="material-symbols-outlined">timer</mat-icon>
            Durée
          </div>
        </th>
        <td mat-cell *matCellDef="let element">
          <div *ngIf="!element.end" style="display: flex; align-items: center; gap: 6px;">
            <mat-spinner [diameter]="14"></mat-spinner>
            <span class="cell-secondary">En cours...</span>
          </div>
          <div *ngIf="element.end" class="cell-primary" [matTooltip]="element.end * 1000 | date:'dd/MM/yyyy, HH:mm:ss.SSS':'fr'">
            {{ { start: element.start, end: element.end } | duration }}
          </div>
        </td>
      </ng-container>


      <ng-container matColumnDef="user">
        <th mat-header-cell *matHeaderCellDef mat-sort-header style="width:15%">
          <div class="header-cell-content">
            <mat-icon class="material-symbols-outlined">person</mat-icon>
            Utilisateur
          </div>
        </th>
        <td mat-cell *matCellDef="let row"> {{row.user || 'N/A'}} </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns;sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="selectedRequest($event,row)"></tr>
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div *ngIf="!isLoading" class="empty-state-inline">
            <mat-icon class="material-symbols-outlined">cloud_off</mat-icon>
            <span>Aucun résultat pour cette recherche</span>
          </div>
          <div *ngIf="isLoading" class="loading-state-inline">
            <mat-spinner diameter="40"></mat-spinner>
            <span>Chargement des requêtes...</span>
          </div>
        </td>
      </tr>
    </table>
  </div>
  <mat-paginator [pageSizeOptions]="[10, 15, 20]" [hidePageSize]="true" showFirstLastButtons></mat-paginator>
</div>
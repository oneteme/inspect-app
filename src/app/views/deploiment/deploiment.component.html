<!-- En-tête moderne avec statistiques -->
<div class="header-container">
  <div class="title-container">
    <mat-icon class="material-symbols-outlined title-icon">{{ MAPPING_TYPE['deploiment'].icon }}</mat-icon>
    <div class="title-content">
      <h1 class="title-label">{{ MAPPING_TYPE['deploiment'].title }}</h1>
      <div class="subtitle-label">Gestion et supervision des déploiements</div>
    </div>
  </div>

  <!-- Statistiques des serveurs -->
  <div class="stats-container">
    <div class="stat-item stat-online">
      <div class="stat-icon-wrapper">
        <mat-icon class="material-symbols-outlined">check_circle</mat-icon>
      </div>
      <div class="stat-details">
        <div class="stat-value">{{ onlineServerStat }}</div>
        <div class="stat-label">Online</div>
      </div>
    </div>

    <div class="stat-item stat-pending">
      <div class="stat-icon-wrapper">
        <mat-icon class="material-symbols-outlined">schedule</mat-icon>
      </div>
      <div class="stat-details">
        <div class="stat-value">{{ pendingServerStat }}</div>
        <div class="stat-label">Pending</div>
      </div>
    </div>

    <div class="stat-item stat-offline">
      <div class="stat-icon-wrapper">
        <mat-icon class="material-symbols-outlined">cancel</mat-icon>
      </div>
      <div class="stat-details">
        <div class="stat-value">{{ offlineServerStat }}</div>
        <div class="stat-label">Offline</div>
      </div>
    </div>

    <div class="stat-divider"></div>

    <div class="stat-item stat-total">
      <div class="stat-icon-wrapper">
        <mat-icon class="material-symbols-outlined">dns</mat-icon>
      </div>
      <div class="stat-details">
        <div class="stat-value">{{ (lastServerStart.data?.data || []).length }}</div>
        <div class="stat-label">Total</div>
      </div>
    </div>
  </div>
</div>

<!-- Tableau Material moderne -->
<div class="modern-table-container">
  <div class="mat-elevation-z3">
    <div class="table-wrapper">
      <table mat-table [dataSource]="lastServerStart.data || []" #lastServerStartTableSort="matSort" matSort
             matSortActive="duree" matSortDirection="desc" class="modern-mat-table">

        <!-- Colonne Serveur avec Status -->
        <ng-container matColumnDef="appName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            <div class="header-cell-content">
              <mat-icon class="material-symbols-outlined">dns</mat-icon>
              Serveur
            </div>
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="server-cell-content">
              <div class="server-info">
                <div class="server-name">{{ row.appName || 'N/A' }}</div>
              </div>
              <a class="status-indicator-modern"
                 [routerLink]="['/supervision', row.id]"
                 [queryParams]="{env: params.env, start: toDate(activityStatus[row.id].lastTrace - 1000 * 60 * 60 * 12).toISOString(), end: toDate(activityStatus[row.id].lastTrace + 1000 * 60 * 60 * 12).toISOString()}"
                 [matTooltip]="activityStatus[row.id].tooltip"
                 [ngClass]="activityStatus[row.id].css">
                <div class="status-dot"></div>
              </a>
            </div>
          </td>
        </ng-container>

        <!-- Colonne Version -->
        <ng-container matColumnDef="version">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            <div class="header-cell-content">
              <mat-icon class="material-symbols-outlined">label</mat-icon>
              Version
            </div>
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="version-badge-modern"
                 *ngIf="row.version"
                 [ngStyle]="{'cursor': row.configuration ? 'pointer' : 'default'}"
                 (click)="row.configuration ? openConfig(row.configuration) : null"
                 [style.background-color]="versionColor[row.version]"
                 [matTooltip]="row.collector">
              <mat-icon class="material-symbols-outlined" *ngIf="row.configuration">settings</mat-icon>
              {{ row.version }}
            </div>
          </td>
        </ng-container>

        <!-- Colonne Uptime -->
        <ng-container matColumnDef="duree">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            <div class="header-cell-content">
              <mat-icon class="material-symbols-outlined">schedule</mat-icon>
              Depuis
            </div>
          </th>
          <td mat-cell *matCellDef="let row">
            <a class="uptime-link"
               [routerLink]="['/session/startup']"
               [queryParams]="{env: params.env, start: toDate(row.start - 1000 * 60 * 60 * 24).toISOString(), end: toDate(row.start + 1000 * 60 * 60 * 24).toISOString(), server: row.appName}"
               [matTooltip]="'Démarré le ' + (row.start | date:'dd/MM/yyyy à HH:mm:ss':'fr')">
              <span class="uptime-duration">{{ (today.getTime() - row.start) / 1000 | duration }}</span>
            </a>
          </td>
        </ng-container>

        <!-- Colonne Redémarrages -->
        <ng-container matColumnDef="restart">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            <div class="header-cell-content">
              <mat-icon class="material-symbols-outlined">restart_alt</mat-icon>
              Redémarrages
            </div>
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="restart-badge" [class.has-restarts]="row.restart > 0">
              <mat-icon class="material-symbols-outlined">{{ row.restart > 0 ? 'warning' : 'check_circle' }}</mat-icon>
              {{ row.restart }}
            </div>
          </td>
        </ng-container>

        <!-- Colonne Branche -->
        <ng-container matColumnDef="branch">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            <div class="header-cell-content">
              <mat-icon class="material-symbols-outlined">fork_right</mat-icon>
              Branche
            </div>
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="branch-info" *ngIf="row.branch" [matTooltip]="'Hash: ' + row.hash">
              <mat-icon class="material-symbols-outlined">code_blocks</mat-icon>
              {{ row.branch }}
            </div>
            <span class="no-data" *ngIf="!row.branch">-</span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="serverStartDisplayedColumns;sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: serverStartDisplayedColumns;" class="table-row-hover"></tr>

        <!-- État vide -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="serverStartDisplayedColumns.length">
            <div *ngIf="!lastServerStart.isLoading" class="empty-state-inline">
              <mat-icon class="material-symbols-outlined">cloud_off</mat-icon>
              <span>Aucun serveur actif dans l'environnement <strong>{{ params.env }}</strong></span>
            </div>
            <div *ngIf="lastServerStart.isLoading" class="loading-state-inline">
              <mat-spinner diameter="40"></mat-spinner>
              <span>Chargement des serveurs...</span>
            </div>
          </td>
        </tr>
      </table>
    </div>

    <!-- Pagination -->
    <mat-paginator #lastServerStartTablePaginator
                   [pageSize]="10"
                   [hidePageSize]="true"
                   [showFirstLastButtons]="true"
                   class="modern-paginator">
    </mat-paginator>
  </div>
</div>


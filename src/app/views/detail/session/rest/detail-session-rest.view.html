<div *ngIf="session && instance ">
    <div class="header-card">
      <mat-card style="width: 60vw; min-width: 60vw;"
                  [ngClass]="{'success': session.status >= 200 && session.status < 400,
                              'warning': session.status >= 400 && session.status < 500,
                              'fail': session.status >= 500,
                              'unavailable': session.status == 0 && session.end}">
            <mat-card-title>
              <div style="display: flex; gap: 0.5em; align-items: center; width: 90%">
                <mat-icon style="overflow: visible !important;" class="material-symbols-outlined">call_received</mat-icon>
                <span *ngIf="session.end" class="status-badge"
                      [ngClass]="{'success': session.status >= 200 && session.status < 400,
                    'warning': session.status >= 400 && session.status < 500,
                    'fail': session.status >= 500,
                    'unavailable': session.status == 0}">
                  {{session.status}}
                </span>
                <div class="ellipsis" [matTooltip]="session.name">
                  {{ session.name || 'N/A' }}
                </div>
                <mat-spinner *ngIf="!session.end" [diameter]="18"></mat-spinner>
              </div>

              <div class="right">
                <button mat-icon-button [matMenuTriggerFor]="menuEndPoint">
                  <mat-icon>more_vert</mat-icon>
                </button>
              </div>
            </mat-card-title>
            <mat-card-content>
                <div class="ellipsis" [matTooltip]="getSessionUrl()">
                    <a class="url" [href]="getSessionUrl()" target="_blank">
                        [{{ session.method }}] {{ getSessionUrl() }}
                    </a>
                </div>

              <exception-display [type]="session.status >= 200 && session.status < 400 ? 'success' : session.status >= 400 && session.status < 500 ? 'warning' : 'fail'" [exception]="session.exception"></exception-display>
            </mat-card-content>
            <mat-card-footer>
              <label-icon icon="person" [iconOutlined]="true" [size]="20">
                <div style="display: flex; align-items: center; gap: 0.5em">
                  {{ session.user || "N/A" }}
                  le {{ (session.start * 1000) | date: 'dd/MM/yyyy à HH:mm:ss.SSS': 'fr' }}
                </div>
              </label-icon>
              <div style="display: flex; justify-content: space-between; gap: 1em">
                <label-icon icon="launch" [ngClass]="{'icon-disabled': !session.userAgent}" [matTooltip]="session.userAgent" [size]="20">
                </label-icon>
                <label-icon icon="line_style" [ngClass]="{'icon-disabled': !session.contentType}" [matTooltip]="session.contentType" [size]="20">
                </label-icon>
                <label-icon icon="copy_all" [ngClass]="{'icon-disabled': !session.cacheControl}" [matTooltip]="session.cacheControl" [size]="20">
                </label-icon>
                <label-icon icon="compress" [ngClass]="{'icon-disabled': !session.outContentEncoding}" [matTooltip]="session.outContentEncoding" [size]="20">
                </label-icon>
              </div>
              <div class="right">
                  {{ session.inDataSize || 0 }}o
                  <mat-icon style="width: 20px; height: 20px; font-size: 20px;">swap_vert</mat-icon>
                  <div>{{ session.outDataSize }}o en <span [matTooltip]="((session.end * 1000) | date: 'dd/MM/yyyy à HH:mm:ss.SSS': 'fr')" style="font-weight: bold">{{{ start: session.start, end: session.end } | duration}}</span></div>
              </div>

            </mat-card-footer>
        </mat-card>
      <app-server-card style="width: 40vw"
                       (onClick)="navigateOnStatusIndicator($event)"
                       [menu]="menuServer"
                       [instance]="instance"></app-server-card>
    </div>
    <detail-session [session]="session" [completedSession]="completedSession" [instance]="instance" [isLoading]="isLoading"></detail-session>
</div>

<div *ngIf="!isLoading && !session" class="noDataMessage mat-elevation-z5" style="height: calc(100vh - 50px - 1em);">
    <h2>
        Aucun détail disponible .. <br>
    </h2>
</div>

<div *ngIf="isLoading && !session && !instance" style="width: 100%; height: calc(100vh - 50px - 1em); display: flex; flex-direction: row; align-items: center; justify-content: center; font-style: italic; gap: 0.5em">
    <mat-progress-spinner diameter="30" mode="indeterminate"></mat-progress-spinner> Chargement en cours...
</div>

<mat-menu #menuEndPoint="matMenu" xPosition="after">
  <a mat-menu-item [disabled]="sessionParent == null" [ngStyle]="{'pointer-events': sessionParent == null ? 'none' : ''}" [routerLink]="sessionParent?.type == 'rest' ? ['/session', 'rest', sessionParent?.id] : ['/session', sessionParent?.type.toLowerCase(), sessionParent?.id]" [queryParams]="{env: instance?.env}">
    <div style="display: flex;">
      <mat-progress-spinner *ngIf="parentLoading"  style="margin-right: 16px" diameter="24" mode="indeterminate"
                            matTooltip="Chargement de l'appel parent">
      </mat-progress-spinner>
      <mat-icon *ngIf="!parentLoading">move_up</mat-icon>
      Origine Client
    </div>
  </a>
  <a mat-menu-item [routerLink]="['/session', 'rest', session?.id, 'tree']">
    <mat-icon class="material-symbols-outlined">lan</mat-icon>
    Arbre d'appels
  </a>
  <button mat-menu-item [matMenuTriggerFor]="menuStatistic"><mat-icon class="material-symbols-outlined">monitoring</mat-icon>KPI</button>
</mat-menu>

<mat-menu #menuStatistic="matMenu">
  <a mat-menu-item [routerLink]="['/dashboard', 'server', instance?.name]" [queryParams]="{api_name: session?.name, env: instance?.env}"><mat-icon class="material-symbols-outlined">call_received</mat-icon>Appel REST</a>
  <a mat-menu-item [routerLink]="['/dashboard', 'user', session?.user]" [ngStyle]="{'pointer-events': !session?.user ? 'none' : ''}" [disabled]="!session?.user"><mat-icon class="material-symbols-outlined">person</mat-icon>Utilisateur</a>
</mat-menu>

<mat-menu #menuServer="matMenu">
  <a mat-menu-item [routerLink]="['/session', instance?.name, 'dump']" [queryParams]="{env: instance?.env, date: getDate(session?.start * 1000).toISOString()}"><mat-icon class="material-symbols-outlined">view_timeline</mat-icon>Pulse</a>
  <a mat-menu-item [routerLink]="['/dashboard', 'server', instance?.name]" [queryParams]="{env: instance?.env}"><mat-icon class="material-symbols-outlined">monitoring</mat-icon>KPI Serveur</a>
</mat-menu>
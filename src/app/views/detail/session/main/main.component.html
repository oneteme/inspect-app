<div *ngIf="!isLoading && session && instance">
    <div class="header-card">
        <mat-card style="width: 60vw; min-width: 60vw; border-left: 4px solid green"
                  [ngStyle]="{'border-left': session.exception?.type || session.exception?.message ? '4px solid red' : '4px solid green'}">
            <mat-card-title>
                <a style="display: flex; align-items: center; gap: 0.5em">
                    <mat-icon>settings_suggest</mat-icon>
                    {{ '[' + session.type + '] ' + session.name || 'N/A' }}
                </a>
                <div class="right">
                    <button mat-icon-button (click)="navigate($event,'tree')" matTooltip="Arbre d'appels">
                        <mat-icon>lan</mat-icon>
                    </button>
                </div>
            </mat-card-title>
            <mat-card-content>
                <span *ngIf="session.location">
                    <a class="url" [href]="session.location" target="_blank">
                        {{ session.location }}
                    </a>
                </span>

                <div style="display: flex; align-items: center; gap: 0.5em; color: red; font-weight: 500; margin-top: 0.5em;"
                     *ngIf="session.exception?.type || session.exception?.message"
                     [matTooltip]="session.exception?.type" TooltipPosition="below">
                    <mat-icon class="material-symbols-outlined" style="width: 28px; height: 28px;">warning</mat-icon>
                    <div class="ellipsis">{{ session.exception?.message || session.exception?.type }}</div>
                </div>
            </mat-card-content>
            <mat-card-footer>
                <mat-icon style="width: 20px; height: 20px; font-size: 20px;">person</mat-icon>
                <div style="display: flex; align-items: center; gap: 0.5em">
                    <a [style.pointer-events]="session.user ? 'auto' : 'none'"
                       [routerLink]="'/statistic/user/' + session.user" [queryParams]="{'env': instance.env}"
                       matTooltip="Statistiques Utilisateur">
                        {{ session.user || "N/A" }}
                    </a>
                    le {{ (session.start * 1000) | date: 'dd/MM/yyyy à HH:mm:ss.SSS': 'fr' }}
                </div>
            </mat-card-footer>
        </mat-card>
        <mat-card style="width: 40vw;">
            <mat-card-title>
                <a style="display: flex; align-items: center; gap: 0.5em"
                   [routerLink]="'/statistic/app/'+ instance.name"
                   [queryParams]="{'env': instance.env}" matTooltip="Statistiques Application">
                    <mat-icon>storage</mat-icon>
                    <div>{{instance.name}} <span style="font-size: 12px; font-style: italic; font-weight: normal;">{{instance.version}}</span></div>
                </a>
                <div style="height: 48px">

                </div>
            </mat-card-title>
            <mat-card-content>
                <div style="display: flex; align-items: center;" *ngFor="let item of queryBySchema | keyvalue ">
                    <div style="display: flex; margin-right: 1em; margin-left: 1em;" *ngIf="item.key != 'null'">
                        <mat-icon class="material-symbols-outlined">Database</mat-icon>
                    </div>
                    <div *ngIf="item.key != 'null'">
                        <a style="font-weight: 500; font-size: 14px;"
                           [routerLink]="'/statistic/database/'+ item.key"
                           [queryParams]="{'env': instance.env}"
                           matTooltip="Statistiques Base de donnée">
                            {{ item.key }}
                        </a>
                        <div style="font-style: italic; font-size: 12px;">
                            {{ item.value[0].productName }} v.{{ item.value[0].productVersion }}
                        </div>
                    </div>
                </div>
            </mat-card-content>
            <mat-card-footer>
                <div style="font-style: italic; font-size: 14px;">
                    {{instance.address}} en {{instance.env}}
                </div>
                <span style="margin-left: auto;">
                    {{instance.os}}
                </span>
                <span style="margin-left: auto;">
                    {{instance.re}}
                </span>
            </mat-card-footer>
        </mat-card>
    </div>
    <div *ngIf="session.requests?.length" style="margin-bottom: 2em;">
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; align-content: center; margin-bottom:  0.5em;">
            <mat-divider style="margin-right: 2em; flex: 1 1 0"></mat-divider>
            <div style="display: flex; align-items: center; gap: 0.5em; font-size: 20px; font-weight: 500;">
                <mat-icon>call_made</mat-icon>
                <div [matBadge]="session.requests?.length" matBadgeOverlap="false" matBadgeColor="primary">API</div>
            </div>
            <mat-divider style="margin-left: 2em; flex: 1 1 0"></mat-divider>
        </div>
        <rest-table [requests]="session.requests"
                    (onClickRow)="selectedRequest($event)"></rest-table>
    </div>
    <div *ngIf="session.ftpRequests?.length" style="margin-bottom: 2em;">
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; align-content: center; margin-bottom:  0.5em;">
            <mat-divider style="margin-right: 2em; flex: 1 1 0"></mat-divider>
            <div style="display: flex; align-items: center; gap: 0.5em; font-size: 20px; font-weight: 500;">
                <mat-icon class="material-symbols-outlined">smb_share</mat-icon>
                <div [matBadge]="session.ftpRequests?.length" matBadgeOverlap="false" matBadgeColor="primary">FTP</div>
            </div>
            <mat-divider style="margin-left: 2em; flex: 1 1 0"></mat-divider>
        </div>
        <ftp-table [requests]="session.ftpRequests"
                   (onClickRow)="selectedFtp($event)">
        </ftp-table>
    </div>
    <div *ngIf="session.mailRequests?.length" style="margin-bottom: 2em;">
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; align-content: center; margin-bottom:  0.5em;">
            <mat-divider style="margin-right: 2em; flex: 1 1 0"></mat-divider>
            <div style="display: flex; align-items: center; gap: 0.5em; font-size: 20px; font-weight: 500;">
                <mat-icon class="material-symbols-outlined">outgoing_mail</mat-icon>
                <div [matBadge]="session.mailRequests?.length" matBadgeOverlap="false" matBadgeColor="primary">SMTP</div>
            </div>
            <mat-divider style="margin-left: 2em; flex: 1 1 0"></mat-divider>
        </div>
        <smtp-table [requests]="session.mailRequests"
                    (onClickRow)="selectedSmtp($event)">
        </smtp-table>
    </div>
    <div *ngIf="session.ldapRequests?.length" style="margin-bottom: 2em;">
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; align-content: center; margin-bottom:  0.5em;">
            <mat-divider style="margin-right: 2em; flex: 1 1 0"></mat-divider>
            <div style="display: flex; align-items: center; gap: 0.5em; font-size: 20px; font-weight: 500;">
                <mat-icon class="material-symbols-outlined">user_attributes</mat-icon>
                <div [matBadge]="session.ldapRequests?.length" matBadgeOverlap="false" matBadgeColor="primary">LDAP</div>
            </div>
            <mat-divider style="margin-left: 2em; flex: 1 1 0"></mat-divider>
        </div>
        <ldap-table [requests]="session.ldapRequests"
                    (onClickRow)="selectedLdap($event)">
        </ldap-table>
    </div>
    <div *ngIf="session.queries?.length" style="margin-bottom: 2em;">
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; align-content: center;  margin-bottom:  0.5em;">
            <mat-divider style="margin-right: 2em; flex: 1 1 0"></mat-divider>
            <div style="display: flex; align-items: center; gap: 0.5em; font-size: 20px; font-weight: 500;">
                <mat-icon class="material-symbols-outlined">Database</mat-icon>
                <div [matBadge]="session.queries?.length" matBadgeOverlap="false" matBadgeColor="primary">BDD</div>
            </div>
            <mat-divider style="margin-left: 2em; flex: 1 1 0"></mat-divider>
        </div>
        <database-table [requests]="session.queries"
                        (onClickRow)="selectedQuery($event)">
        </database-table>
    </div>
    <div *ngIf="session.queries?.length || session.requests?.length" style="margin-bottom: 1em;">
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; align-content: center; margin-bottom:  0.5em;">
            <mat-divider style="margin-right: 2em; flex: 1 1 0"></mat-divider>
            <div style="display: flex; align-items: center; gap: 0.5em; font-size: 20px; font-weight: 500;">
                <mat-icon class="material-symbols-outlined">view_timeline</mat-icon>
                Chronologie
            </div>
            <mat-divider style="margin-left: 2em; flex: 1 1 0"></mat-divider>
        </div>
        <timeline-table [request]="session" [instance]="instance"></timeline-table>
    </div>
</div>

<div *ngIf="!isLoading && !session && !instance" class="noDataMessage mat-elevation-z5" style="height: calc(100vh - 50px - 1em);">
    <h2>
        Aucun détail disponible .. <br>
    </h2>
</div>

<div *ngIf="isLoading" style="width: 100%; height: calc(100vh - 50px - 1em); display: flex; flex-direction: row; align-items: center; justify-content: center; font-style: italic; gap: 0.5em">
    <mat-progress-spinner diameter="30" mode="indeterminate"></mat-progress-spinner> Chargement en cours...
</div>
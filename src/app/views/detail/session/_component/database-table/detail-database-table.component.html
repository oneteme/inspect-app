<div *ngIf="useFilter" style="display: flex; justify-content: space-between; margin-bottom: 1em;" >
    <mat-form-field appearance="outline" class="searchwidth md-3 no-subscript">
        <mat-label>Rechercher dans les requêtes BDD...</mat-label>
        <input [disabled]="isLoading" matInput (keyup)="applyFilter($event)" placeholder="Hôte, schéma, commande..." autocomplete="off">
        <mat-icon matPrefix style="margin-right: 8px; color: #94a3b8;">search</mat-icon>
    </mat-form-field>
</div>
<div class="mat-elevation-z8">
  <div class="table-container">
    <table mat-table [dataSource]="dataSource" style="width:100%;" #sort="matSort" matSort
        matSortActive="start" matSortDirection="desc" class="fullwidthFixed">

        <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef style="width:1%; min-width: 24px;"></th>
            <td [ngClass]="{'success': element.end && !element.failed,
                          'fail': element.end && element.failed,
                          'in-progress': !element.end}"
                mat-cell *matCellDef="let element"
                [matTooltip]="element.failed ? ((element.exception?.type | exceptionType) + ' - ' + (element.exception?.message | truncString: 100)) : 'Succès'"
                matTooltipPosition="after"
                style="padding-left: 24px;">
            </td>
        </ng-container>

        <ng-container matColumnDef="host">
            <th mat-header-cell *matHeaderCellDef mat-sort-header style="width:40%">
                <div style="display: flex; align-items: center; gap: 0.4em;">
                    <mat-icon class="material-symbols-outlined" style="font-size: 16px; width: 16px; height: 16px;">dns</mat-icon>
                    Hôte & Version
                </div>
            </th>
            <td mat-cell *matCellDef="let element">
                <div class="info-cell">
                    <span class="primary-text">{{element["host"] || 'N/A'}}</span>
                    <span class="secondary-text" *ngIf="element['productVersion']">{{element['productVersion']}}</span>
                </div>
            </td>
        </ng-container>

        <ng-container matColumnDef="schema">
            <th mat-header-cell *matHeaderCellDef mat-sort-header style="width:25%">
                <div style="display: flex; align-items: center; gap: 0.4em;">
                    <mat-icon class="material-symbols-outlined" style="font-size: 16px; width: 16px; height: 16px;">storage</mat-icon>
                    Commande & Schéma
                </div>
            </th>
            <td mat-cell *matCellDef="let element">
                <div class="info-cell">
                    <span [class]="'command-badge ' + getCommandClass(element.command)">
                        {{element.command | typeColumnFormat}}
                    </span>
                    <span class="secondary-text">{{element["schema"] || element["name"] || 'N/A'}}</span>
                </div>
            </td>
        </ng-container>

        <ng-container matColumnDef="start">
            <th mat-header-cell *matHeaderCellDef mat-sort-header style="width:20%">
                <div style="display: flex; align-items: center; gap: 0.4em;">
                    <mat-icon class="material-symbols-outlined" style="font-size: 16px; width: 16px; height: 16px;">schedule</mat-icon>
                    Début
                </div>
            </th>
            <td mat-cell *matCellDef="let element">
                <div class="info-cell">
                    <span class="primary-text">{{ (element.start*1000 |date:'dd/MM/yyyy')}}</span>
                    <span class="secondary-text">{{ (element.start*1000 |date:'HH:mm:ss.SSS')}}</span>
                </div>
            </td>
        </ng-container>

        <ng-container matColumnDef="duree">
            <th mat-header-cell *matHeaderCellDef mat-sort-header style="width:14%; text-align: center;">
                <div style="display: flex; align-items: center; gap: 0.4em; justify-content: center;">
                    <mat-icon class="material-symbols-outlined" style="font-size: 16px; width: 16px; height: 16px;">timer</mat-icon>
                    Durée
                </div>
            </th>
            <td mat-cell *matCellDef="let element" style="text-align: center;">
              <mat-spinner *ngIf="!element.end" [diameter]="18" style="margin: auto;"></mat-spinner>
              <div *ngIf="element.end"
                   [matTooltip]="'Fin: ' + (element.end * 1000 | date:'dd/MM/yyyy, HH:mm:ss.SSS':'fr')"
                   style="font-weight: 600; color: #1e293b; font-variant-numeric: tabular-nums; font-size: 13px;">
                {{ { start: element.start, end: element.end } | duration }}
              </div>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="selectedQuery($event, row.id)"></tr>

        <tr class="mat-row mat-mdc-row mat-mdc-no-data-row" *matNoDataRow>
            <td class="mat-cell mat-mdc-cell" [attr.colspan]="displayedColumns.length">
                <div *ngIf="!isLoading" class="loading-row">
                    <mat-icon class="material-symbols-outlined">info</mat-icon>
                    <span style="font-style: italic;">Aucune requête de base de données trouvée</span>
                </div>
                <div *ngIf="isLoading" class="loading-row">
                    <span style="display: flex; flex-direction: column; align-items: center; gap: 1em; font-style: italic;">
                        Chargement des requêtes...
                        <mat-progress-bar mode="indeterminate" style="width: 200px;"></mat-progress-bar>
                    </span>
                </div>
            </td>
        </tr>
    </table>
  </div>
  <mat-paginator #paginator
                 [pageSize]="pageSize || 10"
                 [pageSizeOptions]="[5, 10, 20, 50]"
                 [hidePageSize]="false"
                 showFirstLastButtons
                 [length]="dataSource.data.length">
  </mat-paginator>
</div>
<div *ngIf="!isLoading && request && instance">
  <div class="header-card">
    <mat-card style="width: 60vw; min-width: 60vw;"
              [ngClass]="{'success': request.status >= 200 && request.status < 400,
                        'warning': request.status >= 400 && request.status < 500,
                        'fail': request.status >= 500,
                        'unavailable': request.end && request.status == 0}">
      <mat-card-title>
        <div style="display: flex; gap: 0.5em; align-items: center; width: 85%">
          <mat-icon style="overflow: visible !important;" class="material-symbols-outlined">{{ REQUEST_TYPE['rest'].icon }}</mat-icon>
          <span *ngIf="request.end" class="status-badge"
            [ngClass]="{'success': request.status >= 200 && request.status < 400,
                'warning': request.status >= 400 && request.status < 500,
                'fail': request.status >= 500,
                'unavailable': request.status == 0}">
              {{request.status}}
          </span>
          <div class="ellipsis" [matTooltip]="request.path">
            {{ request.path || 'N/A' }}
          </div>
          <mat-spinner *ngIf="!request.end" [diameter]="18"></mat-spinner>
        </div>
          <div class="right">
              <button mat-icon-button [matMenuTriggerFor]="menuHost">
                  <mat-icon>more_vert</mat-icon>
              </button>
          </div>
      </mat-card-title>
      <mat-card-content>
        <div class="ellipsis">
          <a class="url" [href]="getSessionUrl()" target="_blank">
            [{{ request.method }}] {{ getSessionUrl() }}
          </a>
        </div>
        <exception-display [type]="request.status >= 200 && request.status < 400 ? 'success' : request.status >= 400 && request.status < 500 ? 'warning' : 'fail'" [exception]="exception"></exception-display>
      </mat-card-content>
      <mat-card-footer>
        <label-icon icon="person" [iconOutlined]="true" [size]="20">
          <div style="display: flex; align-items: center; gap: 0.5em">
            {{ request.user || "N/A" }}
            le {{ (request.start * 1000) | date: 'dd/MM/yyyy à HH:mm:ss.SSS': 'fr' }}
          </div>
        </label-icon>
        <div class="right">
          {{ request.outDataSize }}o
          <mat-icon style="width: 20px; height: 20px; font-size: 20px;">swap_vert</mat-icon>
          <div>{{ request.inDataSize }}o en
          <span [matTooltip]="((request.end * 1000) | date: 'dd/MM/yyyy à HH:mm:ss': 'fr')" style="font-weight: bold">
            {{{start: request.start, end: request.end} | duration }}
          </span></div>
        </div>
      </mat-card-footer>
    </mat-card>
    <app-server-card style="width: 40vw"
                     (onClick)="navigateOnStatusIndicator($event)"
                     [menu]="menuServer"
                     [instance]="instance"></app-server-card>
  </div>
  <div class="tabs-container">
    <!-- Navigation verticale des onglets -->
    <div class="vertical-tabs">
      <div *ngFor="let tab of tabs; let i = index"
           class="tab-button"
           [class.active]="selectedTabIndex === i"
           [class.hidden]="!tab.visible"
           (click)="selectedTabIndex = i">
        <mat-icon class="material-symbols-outlined">{{ tab.icon }}</mat-icon>
        <div class="tab-label-container">
          <span class="tab-label">{{ tab.label }}</span>
          <mat-icon *ngIf="tab.hasError && tab.errorCount > 0"
                    class="error-indicator material-symbols-outlined"
                    [matTooltip]="tab.errorCount + ' erreur(s)'"
                    matTooltipPosition="right">
            error
          </mat-icon>
        </div>
        <span class="tab-count" *ngIf="tab.count > 0">{{ tab.count | numberFormat:0:'≈' }}</span>
      </div>
    </div>
    <div class="tab-content">
      <div *ngIf="tabs[selectedTabIndex]?.type === 'stage'" class="tab-panel">
        <request-stage-table [requests]="stages">
        </request-stage-table>
      </div>
      <div *ngIf="tabs[selectedTabIndex]?.type === 'timeline'" class="tab-panel">
        <app-timeline [options]="options"
                      [groups]="dataGroups"
                      [items]="dataItems"
                      [displayHeader]="false">
        </app-timeline>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!isLoading && !request && !instance" class="noDataMessage mat-elevation-z5" style="height: calc(100vh - 50px - 1em);">
  <h2>
    Aucun détail disponible ..
  </h2>
</div>
<div *ngIf="isLoading"
     style="width: 100%; height: calc(100vh - 50px - 1em); display: flex; flex-direction: row; align-items: center; justify-content: center; font-style: italic; gap: 0.5em">
  <mat-progress-spinner diameter="30" mode="indeterminate"></mat-progress-spinner>
  Chargement en cours...
</div>

<mat-menu #menuHost="matMenu">
    <div mat-menu-item [disabled]="request.status != 0 && !request.linked" (click)="navigate($event, 'remote')"><mat-icon class="material-symbols-outlined">link</mat-icon>Détail de la session</div>
    <div mat-menu-item [disabled]="sessionParent == null" (click)="navigate($event,'parent')"><mat-icon class="material-symbols-outlined" (click)="navigate($event,'parent')">move_up</mat-icon>Détail de l'appel parent</div>
    <a mat-menu-item [routerLink]="['/dashboard/request', 'rest', request?.host]" [queryParams]="{env: instance?.env}"><mat-icon class="material-symbols-outlined">monitoring</mat-icon>KPI Request</a>

</mat-menu>

<mat-menu #menuServer="matMenu">
  <a mat-menu-item [routerLink]="['/session', instance?.name, 'dump']" [queryParams]="{env: instance?.env, date: getDate(request?.start * 1000).toISOString()}"><mat-icon class="material-symbols-outlined">view_timeline</mat-icon>Pulse</a>
  <a mat-menu-item [routerLink]="['/dashboard', 'server', instance?.name]" [queryParams]="{env: instance?.env}"><mat-icon class="material-symbols-outlined">monitoring</mat-icon>KPI Serveur</a>
</mat-menu>
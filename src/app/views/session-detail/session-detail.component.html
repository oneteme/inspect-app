<div *ngIf="!isLoading && selectedSession">
    <div class="header-card">
        <mat-card style="width: 60vw; min-width: 60vw;" [ngStyle]="getSessionDetailBorder()">

            <mat-card-title>
                <a style="display: flex; align-items: center; gap: 0.5em"
                    [routerLink]="'/dashboard/api/'+ selectedSession?.name"
                    [queryParams]="{'env': instance?.env}"
                    [style.pointer-events]="selectedSession?.type == 'VIEW' || selectedSession?.type == 'STARTUP' ? 'none' : 'all'"
                    matTooltip="Statistique API">
                    <mat-icon>settings_suggest</mat-icon>
                    {{selectedSessionType =='api' ? (selectedSession?.name|| 'N/A')
                    : '['
                    + selectedSession?.type + '] ' + selectedSession?.name || 'N/A'}}
                </a>
                <div class="right">
                    <button mat-icon-button (click)="navigate($event,'parent')" matTooltip="Détail de l'appel parent"
                        [disabled]="!sessionParent">
                        <mat-icon>move_up</mat-icon>
                    </button>
                    <button mat-icon-button (click)="navigate($event,'tree')" matTooltip="Arbre d'appels API">
                        <mat-icon>lan</mat-icon>
                    </button>
                </div>

            </mat-card-title>
            <mat-card-content>
                <div *ngIf="selectedSessionType =='api'">
                    <div class="ellipsis">
                        <a class="url" [href]="getSessionUrl()" target="_blank">
                            [{{selectedSession?.method}}]
                            {{getSessionUrl()}}
                        </a>
                    </div>

                    <div class="ellipsis"
                        style="display: flex; gap: 0.5em; color: red; font-weight: 500; margin-top: 0.5em;"
                        *ngIf="selectedSession?.exception?.type || selectedSession?.exception?.message "
                        [matTooltip]="selectedSession?.exception?.type" TooltipPosition="below">
                        <mat-icon
                            class="material-symbols-outlined">warning</mat-icon>{{selectedSession?.exception?.message
                        || selectedSession?.exception?.type}}
                    </div>
                </div>

                <div *ngIf="selectedSessionType=='main'">
                    <span *ngIf="selectedSession.location">
                        <a class="url" [href]="selectedSession?.location" target="_blank">
                            {{selectedSession?.location}}
                        </a>
                    </span>
                </div>

            </mat-card-content>
            <mat-card-footer>
                <mat-icon style="width: 20px; height: 20px; font-size: 20px;">person</mat-icon>
                <div style="display: flex; align-items: center; gap: 0.5em">
                    <a [style.pointer-events]="selectedSession?.user? 'auto' : 'none'"
                        [routerLink]="'/dashboard/user/'+ selectedSession?.user" [queryParams]="{'env': instance?.env}"
                        matTooltip="Statistique Utilisateur">
                        {{selectedSession?.user || "N/A"}}
                    </a>
                    le {{( selectedSession?.start*1000 ) | date: 'dd/MM/yyyy à HH:mm:ss.SSS': 'fr' }}
                </div>
                <div class="right">
                    {{selectedSession?.inDataSize || 0}}o
                    <mat-icon style="width: 20px; height: 20px; font-size: 20px;">swap_vert</mat-icon>
                    {{selectedSession?.outDataSize}}o en {{ getElapsedTime(selectedSession?.end, selectedSession?.start)
                    |
                    number :'1.2-3'}}s
                </div>
                <span class="badge" [style.background-color]="getStateColor()">{{selectedSession?.status}}</span>
            </mat-card-footer>
        </mat-card>
        <mat-card style="width: 40vw;">
            <mat-card-title>
                <a style="display: flex; align-items: center; gap: 0.5em"
                    [routerLink]="'/dashboard/app/'+ instance?.name"
                    [style.pointer-events]="selectedSession?.type == 'VIEW' ? 'none' : 'all'"
                    [queryParams]="{'env': instance?.env}" matTooltip="Statistique Serveur">
                    <mat-icon>storage</mat-icon>
                    {{instance?.name}}
                </a>
                <div style="height: 48px">

                </div>
            </mat-card-title>
            <mat-card-content>

                <div style="display: flex; align-items: center;" *ngFor="let item of queryBySchema | keyvalue ">
                    <div style="display: flex; margin-right: 1em; margin-left: 1em;" *ngIf="item.key != 'null'">
                        <mat-icon class="material-symbols-outlined">Database</mat-icon>
                    </div>
                    <div *ngIf="item.key != 'null'">
                        <a style="font-weight: 500; font-size: 14px;" [routerLink]="'/dashboard/database/'+ item.key"
                            [queryParams]="{'env': instance?.env}"
                            matTooltip="Statistique Base de donnée">
                            {{ item.key }}
                        </a>
                        <div style="font-style: italic; font-size: 12px;">{{ item.value[0].productName }} v.{{
                            item.value[0].productVersion}}</div>
                    </div>
                </div>


            </mat-card-content>
            <mat-card-footer>
                <div style="font-style: italic; font-size: 14px;">
                    {{instance?.address}} en {{instance?.env}}
                </div>
                <span style="margin-left: auto;">
                    {{instance?.os}}
                </span>
                <span style="margin-left: auto;">
                    {{instance?.re}}
                </span>
            </mat-card-footer>
        </mat-card>
    </div>
    <div *ngIf="selectedSession?.requests?.length" style="margin-bottom: 2em;">
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; align-content: center;">
            <mat-divider style="margin-right: 1em; flex: 1 1 0%"></mat-divider>
            <div
                style="display: flex; align-items: center; gap: 0.5em; margin-bottom:  0.5em; font-size: 20px; font-weight: 500;">
                <mat-icon>west</mat-icon>
                <div [matBadge]="selectedSession?.requests?.length" matBadgeOverlap="false" matBadgeColor="custom">
                    Appels
                    sortants</div>
            </div>
            <mat-divider style="margin-left: 1em; flex: 1 1 0%"></mat-divider>
        </div>
        <request-rest-table [requests]="selectedSession.requests"
            (onClickRow)="selectedRequest($event)"></request-rest-table>
    </div>
    <div *ngIf="selectedSession?.queries?.length" style="margin-bottom: 2em;">
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; align-content: center;">
            <mat-divider style="margin-right: 1em; flex: 1 1 0%"></mat-divider>
            <div
                style="display: flex; align-items: center; gap: 0.5em; margin-bottom:  0.5em; font-size: 20px; font-weight: 500;">
                <mat-icon class="material-symbols-outlined">Database</mat-icon>
                <div [matBadge]="selectedSession?.queries?.length" matBadgeOverlap="false" matBadgeColor="custom">Base de
                    donnée</div>
            </div>
            <mat-divider style="margin-left: 1em; flex: 1 1 0%"></mat-divider>
        </div>
        <request-database-table [requests]="selectedSession.queries"
            (onClickRow)="selectedQuery($event)"></request-database-table>
    </div>
    <div *ngIf="selectedSession?.queries?.length || selectedSession?.requests?.length">
        <div
            style="display: flex; flex-direction: row; justify-content: center; align-items: center; align-content: center;">
            <mat-divider style="margin-right: 1em; flex: 1 1 0%"></mat-divider>
            <div
                style="display: flex; align-items: center; gap: 0.5em; margin-bottom:  0.5em; font-size: 20px; font-weight: 500;">
                <mat-icon class="material-symbols-outlined">view_timeline</mat-icon>
                Chronologie
            </div>
            <mat-divider style="margin-left: 1em; flex: 1 1 0%"></mat-divider>
        </div>
        <request-timeline-table [request]="selectedSession" [instance]="instance"></request-timeline-table>
    </div>
</div>
<div *ngIf="!isLoading && !selectedSession" class="noDataMessage mat-elevation-z5"
    style="height: calc(100vh - 50px - 1em); display: flex;">
    <h2>
        Aucun détail disponible .. <br>
        <span *ngIf="selectedSession">Vérifiez que TraceAPI est bien configuré sur <b>{{
                selectedSession?.host}}</b></span>
    </h2>
</div>
<div *ngIf="isLoading"
    style="width: 100%; height: calc(100vh - 50px - 1em); display: flex; flex-direction: row; align-items: center; justify-content: center; font-style: italic; gap: 0.5em">
    <mat-progress-spinner diameter="30" mode="indeterminate"></mat-progress-spinner> Chargement en cours...
</div>
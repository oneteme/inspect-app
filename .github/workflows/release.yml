name: tag release
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install
      - run: npm run build
      - uses: SonarSource/sonarqube-scan-action@v4.2.1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      - name: extract version
        id: npmVer
        run: echo "version=$(node -p 'require("./package.json").version')" >>$GITHUB_OUTPUT
    outputs:
      version: ${{ steps.npmVer.outputs.version }}
  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        branch: "${{ github.ref_name }}"
        version: "v${{ needs.build.outputs.version }}"
      run: gh release create "$version" --repo="$GITHUB_REPOSITORY" --target="$branch" --title="$version" --generate-notes
